<!-- Cookie Banner Component -->
<div id="cookie-consent-overlay">
  <div id="cookie-consent-banner">
    <div class="layout">
      <p>
        Продолжая работу на сайте, Вы соглашаетесь с 
        <a href="/terms/" class="" aria-label="Узнать больше об условия использования">условиями использования</a> 
        и 
        <a href="/privacy-policy/" class="" aria-label="Узнать больше о политике конфиденциальности">политикой конфиденциальности</a>. 
        А еще мы используем 
        <a href="/cookies/" class="" aria-label="Узнать больше об использования cookies">cookies</a>.
      </p>
      <button class="cookie-btn">Ok</button>
    </div>
  </div>
</div>

<script>
const overlay = document.querySelector<HTMLElement>('#cookie-consent-overlay');
const cookieButton = document.querySelector<HTMLButtonElement>('.cookie-btn');
const COOKIE_AGREED_KEY = 'cookieAgreed';

const hasConsented = (): boolean => localStorage.getItem(COOKIE_AGREED_KEY) === 'true';
let yandexInitialized = false;
let mailruInitialized = false;

// Add padding to body when popup is active
const addBodyPadding = (): void => {
  document.body.style.paddingBottom = '80px';
};

const removeBodyPadding = (): void => {
  document.body.style.paddingBottom = '';
};

declare global {
  interface Window { 
    ym?: (...args: any[]) => void; 
    _tmr?: any[];
  }
}

// YANDEX

const addNoscriptPixel = (): void => {
  const img = document.createElement('img');
  img.src = 'https://mc.yandex.ru/watch/103487153';
  img.style.position = 'absolute';
  img.style.left = '-9999px';
  img.alt = '';

  const div = document.createElement('div');
  div.appendChild(img);
  document.body.appendChild(div);
};

const yandexMetrika = (): void => {
  if (!hasConsented() || yandexInitialized) return;
  yandexInitialized = true;
  addNoscriptPixel();

  (function (m: any, e: Document, t: string, r: string, i: string) {
    m[i] = m[i] || function (...args: any[]) { (m[i].a = m[i].a || []).push(args); };
    m[i].l = Date.now();

    if ([...e.scripts].some(script => script.src === r)) return;

    const k = e.createElement(t) as HTMLScriptElement;
    const a = e.getElementsByTagName(t)[0];
    k.async = true;
    k.src = r;
    a?.parentNode?.insertBefore(k, a);
  })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js', 'ym');

  window.ym?.(103487153, 'init', {
    clickmap: true,
    trackLinks: true,
    accurateTrackBounce: true,
    webvisor: true,
    ecommerce: 'dataLayer',
  });
};


// MAIL

const addMailruNoscriptPixel = (): void => {
  const img = document.createElement('img');
  img.src = 'https://top-fwz1.mail.ru/counter?id=3709261;js=na';
  img.style.position = 'absolute';
  img.style.left = '-9999px';
  img.alt = 'Top.Mail.Ru';
  const div = document.createElement('div');
  div.appendChild(img);
  document.body.appendChild(div);
};

const mailruCounter = (): void => {
  if (!hasConsented() || mailruInitialized) return;
  mailruInitialized = true;
  addMailruNoscriptPixel();

  window._tmr = window._tmr || [];
  window._tmr.push({ id: '3709261', type: 'pageView', start: new Date().getTime() });

  (function (d, w, id) {
    if (d.getElementById(id)) return;
    const ts = d.createElement('script');
    ts.type = 'text/javascript';
    ts.async = true;
    ts.id = id;
    ts.src = 'https://top-fwz1.mail.ru/js/code.js';
    const f = function () {
      const s = d.getElementsByTagName('script')[0];
      s?.parentNode?.insertBefore(ts, s);
    };
    if ((w as any).opera === '[object Opera]') d.addEventListener('DOMContentLoaded', f, false);
    else f();
  })(document, window, 'tmr-code');
};


if (overlay) {
  const active = !hasConsented();
  overlay.classList.toggle('active', active);

  if (active) {
    addBodyPadding();
  } else {
    removeBodyPadding();
  }
}

cookieButton?.addEventListener('click', () => {
  overlay?.classList.remove('active');
  localStorage.setItem(COOKIE_AGREED_KEY, 'true');
  yandexMetrika();
  mailruCounter();

  removeBodyPadding();
});

document.addEventListener('DOMContentLoaded', () => {
  if (hasConsented()) {
    yandexMetrika();
    mailruCounter();
  }
});
</script>


<style>
  #cookie-consent-overlay {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 999999;
    pointer-events: none;
    opacity: 0;
    transform: translateY(100%);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  #cookie-consent-overlay.active {
    pointer-events: all;
    opacity: 1;
    transform: translateY(0);
  }

  #cookie-consent-banner {
    background: transparent;
    color: #fff;
    padding: 1rem 2rem;
    border-radius: 0;
    max-width: none;
    /* width: 100%; */
    text-align: left;
    transform: none;
    transition: none;
    opacity: 1;
  }

  .layout {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .layout p {
    font-size: 0.875rem;
    margin: 0;
    flex: 1;
    line-height: 1.4;
  }

  .cookie-btn {
    font-size: 0.875rem;
    color: #fff;
    background: var(--color-blue, #007bff);
    text-transform: uppercase;
    cursor: pointer;
    transition: 0.33s ease-in-out opacity;
    margin: 0;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .cookie-btn:hover {
    opacity: 0.8;
  }

  #cookie-consent-banner a {
    color: var(--color-blue-link, #66b3ff);
    transition: color 0.33s ease-in;
    text-decoration: underline;
  }

  #cookie-consent-banner a:hover {
    color: #fff;
  }

  @media (max-width: 768px) {
    .layout {
      flex-direction: column;
      text-align: center;
      gap: 0.75rem;
    }
    
    .layout p {
      font-size: 0.8rem;
    }
    
    .cookie-btn {
      width: 100%;
      padding: 0.75rem;
    }
  }
</style>

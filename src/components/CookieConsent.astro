<!-- Cookie Banner Component -->
<div id="cookie-consent-overlay">
  <div id="cookie-consent-banner">
    <div class="layout">
      <p>
        Продолжая работу на сайте, Вы соглашаетесь с 
        <a href="/terms/" class="" aria-label="Узнать больше об условия использования">условиями использования</a> 
        и 
        <a href="/privacy-policy/" class="" aria-label="Узнать больше о политике конфиденциальности">политикой конфиденциальности</a>. 
        А еще мы используем 
        <a href="/cookies/" class="" aria-label="Узнать больше об использования cookies">cookies</a>.
      </p>
      <button class="cookie-btn">Продолжить</button>
    </div>
  </div>
</div>

<script>
const overlay = document.querySelector<HTMLElement>('#cookie-consent-overlay');
const cookieButton = document.querySelector<HTMLButtonElement>('.cookie-btn');
const COOKIE_AGREED_KEY = 'cookieAgreed';

const hasConsented = (): boolean => localStorage.getItem(COOKIE_AGREED_KEY) === 'true';
let yandexInitialized = false;
let mailruInitialized = false;

declare global {
  interface Window { 
    ym?: (...args: any[]) => void; 
    _tmr?: any[];
  }
}

// YANDEX

const addNoscriptPixel = (): void => {
  const img = document.createElement('img');
  img.src = 'https://mc.yandex.ru/watch/103487153';
  img.style.position = 'absolute';
  img.style.left = '-9999px';
  img.alt = '';

  const div = document.createElement('div');
  div.appendChild(img);
  document.body.appendChild(div);
};

const yandexMetrika = (): void => {
  if (!hasConsented() || yandexInitialized) return;
  yandexInitialized = true;
  addNoscriptPixel();

  (function (m: any, e: Document, t: string, r: string, i: string) {
    m[i] = m[i] || function (...args: any[]) { (m[i].a = m[i].a || []).push(args); };
    m[i].l = Date.now();

    if ([...e.scripts].some(script => script.src === r)) return;

    const k = e.createElement(t) as HTMLScriptElement;
    const a = e.getElementsByTagName(t)[0];
    k.async = true;
    k.src = r;
    a?.parentNode?.insertBefore(k, a);
  })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js', 'ym');

  window.ym?.(103487153, 'init', {
    clickmap: true,
    trackLinks: true,
    accurateTrackBounce: true,
    webvisor: true,
    ecommerce: 'dataLayer',
  });
};


// MAIL

const addMailruNoscriptPixel = (): void => {
  const img = document.createElement('img');
  img.src = 'https://top-fwz1.mail.ru/counter?id=3709261;js=na';
  img.style.position = 'absolute';
  img.style.left = '-9999px';
  img.alt = 'Top.Mail.Ru';
  const div = document.createElement('div');
  div.appendChild(img);
  document.body.appendChild(div);
};

const mailruCounter = (): void => {
  if (!hasConsented() || mailruInitialized) return;
  mailruInitialized = true;
  addMailruNoscriptPixel();

  window._tmr = window._tmr || [];
  window._tmr.push({ id: '3709261', type: 'pageView', start: new Date().getTime() });

  (function (d, w, id) {
    if (d.getElementById(id)) return;
    const ts = d.createElement('script');
    ts.type = 'text/javascript';
    ts.async = true;
    ts.id = id;
    ts.src = 'https://top-fwz1.mail.ru/js/code.js';
    const f = function () {
      const s = d.getElementsByTagName('script')[0];
      s?.parentNode?.insertBefore(ts, s);
    };
    if ((w as any).opera === '[object Opera]') d.addEventListener('DOMContentLoaded', f, false);
    else f();
  })(document, window, 'tmr-code');
};

const preventInteraction = (e: Event) => e.preventDefault();
const preventTabNavigation = (e: KeyboardEvent) => {
  if (e.key === 'Tab') e.preventDefault();
};

if (overlay) {
  const active = !hasConsented();
  overlay.classList.toggle('active', active);

  if (active) {
    document.body.style.overflow = 'hidden';
    document.addEventListener('keydown', preventTabNavigation, { capture: true });
    document.addEventListener('wheel', preventInteraction, { passive: false, capture: true });
    document.addEventListener('touchmove', preventInteraction, { passive: false, capture: true });
  }
}

cookieButton?.addEventListener('click', () => {
  overlay?.classList.remove('active');
  localStorage.setItem(COOKIE_AGREED_KEY, 'true');
  yandexMetrika();
  mailruCounter();

  document.body.style.overflow = '';
  document.removeEventListener('keydown', preventTabNavigation, { capture: true });
  document.removeEventListener('wheel', preventInteraction, { capture: true });
  document.removeEventListener('touchmove', preventInteraction, { capture: true });
});

document.addEventListener('DOMContentLoaded', () => {
  if (hasConsented()) {
    yandexMetrika();
    mailruCounter();
  }
});
</script>


<style>
  #cookie-consent-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  #cookie-consent-overlay.active {
    pointer-events: all;
    opacity: 1;
  }

  #cookie-consent-banner {
    background: rgba(0, 0, 0, 0.9);
    color: #fff;
    padding: 2rem;
    border-radius: 12px;
    max-width: 500px;
    text-align: center;
    transform: translateY(50px);
    transition: transform 0.3s ease, opacity 0.3s ease;
    opacity: 0;
  }

  #cookie-consent-overlay.active #cookie-consent-banner {
    transform: translateY(0);
    opacity: 1;
  }

  .layout p {
    font-size: var(--base-font-size);
    margin-bottom: var(--space-half);
  }

  .cookie-btn {
    font-size: var(--base-font-size);
    color: var(--color-dark-blue);
    text-transform: uppercase;
    cursor: pointer;
    transition: 0.33s ease-in-out opacity;
    margin-top: 1rem;
  }

  .cookie-btn:hover {
    opacity: 0.7;
  }

  #cookie-consent-banner a {
    color: var(--color-blue-link);
    transition: color 0.33s ease-in;
  }

  #cookie-consent-banner a:hover {
    color:var(--color-dark-blue);
  }
</style>
